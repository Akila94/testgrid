#!/bin/sh

if [ "$1" = "startup-jenkins" ]; then
    echo "__          _______  ____ ___    _______        _    _____      _     _    _       ____   _____   ___   _      "
    echo "\ \        / / ____|/ __ \__ \  |__   __|      | |  / ____|    (_)   | |  | |    /  __  \/ _____|/    \| |     "
    echo " \ \  /\  / / (___ | |  | | ) |    | | ___  ___| |_| |  __ _ __ _  __| |  | |    | |  | | |     | /__\ | |     "
    echo "  \ \/  \/ / \___ \| |  | |/ /     | |/ _ \/ __| __| | |_ |  __| |/ _  |  | |    | |  | | |     | ____ | |     "
    echo "   \  /\  /  ____) | |__| / /_     | |  __/\__ \ |_| |__| | |  | | (_| |  | |____| |__| | |____ | |  | | |____ "
    echo "    \/  \/  |_____/ \____/____|    |_|\___||___/\__|\_____|_|  |_|\____|  |______|\ ___ /\______|_|  |_|______|"
    echo ""
    echo "Please make sure that the mandatory parameters in params.properties file are set. Process can be stuck in the middle otherwise"
    chmod +x ./tomcat/apache-tomcat-8.5.43/bin/*
    chmod +x ./scripts/install_jenkins_plugins.sh
    chmod +x ./scripts/add_credentials.sh
    chmod +x ./scripts/add_config_provider_files.sh
    chmod +x ./testgrid/testgrid-home/testgrid-dist/WSO2-TestGrid/*

    if [ $(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080) -eq 000 ]
    then

      ./tomcat/apache-tomcat-8.5.43/bin/startup.sh

    	while [ $(curl -s -w "%{http_code}" http://localhost:8080/admin -o /dev/null) -eq 000 ]
    	do
      	  sleep 1
    	done

    	echo "installing plugins....."
    	./scripts/install_jenkins_plugins.sh

    	echo "adding credentials....."
    	./scripts/add_credentials.sh

    	echo "adding config provider files...."
    	./scripts/add_config_provider_files.sh

    else
      echo "another application is already running in localhost:8080...shutdown it to proceed ahead.."
    fi


    if [ $(curl -s -o /dev/null -w "%{http_code}" http://localhost:8082) -eq 000 ]
    then
        echo "starting H2 server....."
        java -jar lib/h2-*.jar  -baseDir ./h2db &> /dev/null &
    fi


elif [ "$1" = "shutdown-jenkins" ]
then

   if [ $(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080) -eq 302 ]
   then
     ./tomcat/apache-tomcat-8.5.43/bin/shutdown.sh
   fi

   if [ $(curl -s -o /dev/null -w "%{http_code}" http://localhost:8082) -eq 200 ]
   then
     java -cp lib/h2-*.jar org.h2.tools.Server -tcpShutdown tcp://localhost:9092
   fi

else
   echo "Invalid command \nValid commands are..\n./local-tg startup-jenkins - to startup local-tg\n./local-tg shutdown-jenkins - to shutdown local-tg"
fi
